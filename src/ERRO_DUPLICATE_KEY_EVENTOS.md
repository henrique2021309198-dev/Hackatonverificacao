# üêõ ERRO: Duplicate Key ao Criar Eventos

## ‚ùå Erro Reportado

```json
{
  "code": "23505",
  "details": null,
  "hint": null,
  "message": "duplicate key value violates unique constraint \"eventos_pkey\""
}
```

---

## üîç O Que Significa?

Este erro acontece quando voc√™ tenta inserir um evento com um **ID que j√° existe** na tabela.

**Poss√≠veis causas:**

1. ‚úÖ **MAIS PROV√ÅVEL:** A coluna `id` da tabela `eventos` n√£o tem **auto-increment** configurado
2. A sequ√™ncia (gerador de IDs) est√° dessincronizada
3. H√° eventos duplicados na tabela

---

## ‚úÖ SOLU√á√ÉO: Verificar e Corrigir Auto-Increment

### **Passo 1: Execute o Script de Verifica√ß√£o**

1. **Abra:** https://app.supabase.com ‚Üí Seu Projeto
2. **V√° em:** SQL Editor ‚Üí New Query
3. **Cole:** Todo o conte√∫do de `/VERIFICAR_TABELA_EVENTOS.sql`
4. **Execute:** Clique em RUN (ou Ctrl+Enter)

### **Passo 2: Veja o Resultado**

O script vai:
- ‚úÖ Verificar se a coluna `id` tem auto-increment
- ‚úÖ Adicionar auto-increment se n√£o tiver
- ‚úÖ Mostrar mensagem de confirma√ß√£o

**Mensagem esperada:**
```
‚úÖ Auto-increment adicionado √† coluna ID da tabela eventos
```

ou

```
‚úÖ A coluna ID j√° tem auto-increment configurado
```

---

## üß™ SOLU√á√ÉO ALTERNATIVA: Limpar e Recriar Eventos (se necess√°rio)

Se o script acima n√£o resolver, voc√™ pode limpar a tabela e recri√°-la:

### **Op√ß√£o A: Deletar Todos os Eventos**

```sql
-- CUIDADO: Isso vai deletar TODOS os eventos!
-- Execute apenas se voc√™ n√£o tem eventos importantes

-- Deletar todos os eventos
DELETE FROM public.eventos;

-- Resetar a sequ√™ncia de IDs para come√ßar do 1
ALTER SEQUENCE eventos_id_seq RESTART WITH 1;

-- Verificar se est√° vazio
SELECT COUNT(*) as total_eventos FROM public.eventos;
-- Deve retornar: total_eventos = 0
```

### **Op√ß√£o B: Deletar Apenas Eventos Duplicados**

```sql
-- Ver eventos duplicados (se houver)
SELECT id, COUNT(*) as quantidade
FROM public.eventos
GROUP BY id
HAVING COUNT(*) > 1;

-- Deletar eventos espec√≠ficos (substitua o ID)
DELETE FROM public.eventos WHERE id = 1; -- exemplo
```

---

## üéØ SOLU√á√ÉO APLICADA NO C√ìDIGO

J√° ajustei o c√≥digo em `/services/supabase.ts` para:

1. ‚úÖ **N√£o especificar ID** ao criar eventos (deixar o banco gerar)
2. ‚úÖ **Adicionar logs** para debug:
   ```
   üìù Criando evento com dados: {...}
   ‚úÖ Evento criado no banco: {...}
   ```
3. ‚úÖ **Mensagem de erro amig√°vel** se der duplicate key:
   ```
   "Erro ao gerar ID do evento. Tente novamente em alguns segundos."
   ```

---

## üîß VERIFICAR SE EST√Å FUNCIONANDO

### **Teste 1: Verificar Auto-Increment**

Execute no SQL Editor:

```sql
-- Ver configura√ß√£o da coluna ID
SELECT column_name, column_default, data_type
FROM information_schema.columns
WHERE table_name = 'eventos' AND column_name = 'id';
```

**Resultado esperado:**
```
column_name | column_default                      | data_type
id          | nextval('eventos_id_seq'::regclass) | integer
```

Se `column_default` estiver vazio ou NULL, voc√™ precisa executar o script de corre√ß√£o.

---

### **Teste 2: Inserir Evento de Teste**

Execute no SQL Editor:

```sql
-- Inserir evento SEM especificar ID
INSERT INTO public.eventos (
    nome,
    descricao,
    data_inicio,
    duracao_horas,
    limite_faltas_percentual,
    valor_evento,
    texto_certificado,
    perfil_academico_foco
) VALUES (
    'Teste de Auto-Increment',
    'Evento de teste',
    NOW() + INTERVAL '7 days',
    2,
    25,
    0,
    'Certificado de teste',
    'todos'
) RETURNING id, nome;
```

**Resultado esperado:**
```
id | nome
----|------------------------
 1  | Teste de Auto-Increment
```

‚úÖ Se retornou um ID, est√° funcionando!

**Deletar o teste:**
```sql
DELETE FROM public.eventos WHERE nome = 'Teste de Auto-Increment';
```

---

## üéì EXPLICA√á√ÉO T√âCNICA

### **Por Que Acontece?**

Quando voc√™ cria uma tabela no PostgreSQL/Supabase, voc√™ precisa especificar que a coluna `id` deve ter **auto-increment**:

```sql
-- Forma correta de criar a tabela
CREATE TABLE eventos (
    id SERIAL PRIMARY KEY,  -- ‚úÖ SERIAL = auto-increment
    nome TEXT NOT NULL,
    -- ...
);

-- OU usar IDENTITY (mais moderno)
CREATE TABLE eventos (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nome TEXT NOT NULL,
    -- ...
);
```

Se a tabela foi criada sem `SERIAL` ou `IDENTITY`, voc√™ precisa adicionar depois:

```sql
ALTER TABLE eventos 
ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY;
```

---

## üìã CHECKLIST DE SOLU√á√ÉO

- [ ] 1. Executei `/VERIFICAR_TABELA_EVENTOS.sql` no SQL Editor
- [ ] 2. Vi a mensagem "Auto-increment adicionado" ou "j√° tem auto-increment"
- [ ] 3. Testei inserir um evento de teste (opcional)
- [ ] 4. Tentei criar um evento pela interface
- [ ] 5. O evento apareceu na tabela `public.eventos` ‚úÖ

---

## üÜò AINDA N√ÉO FUNCIONOU?

Se ainda estiver dando erro ap√≥s executar o script:

1. **Verifique RLS (Row Level Security):**
   ```sql
   -- Ver pol√≠ticas da tabela eventos
   SELECT * FROM pg_policies WHERE tablename = 'eventos';
   ```

2. **Verifique permiss√µes:**
   ```sql
   -- Ver grants
   SELECT grantee, privilege_type 
   FROM information_schema.role_table_grants 
   WHERE table_name = 'eventos';
   ```

3. **Abra o console do navegador (F12)** e veja os logs:
   - `üìù Criando evento com dados: ...`
   - `‚ùå Erro ao criar evento: ...`

4. **Copie os logs e me envie** para eu ajudar a debugar!

---

## üéØ RESUMO

**PROBLEMA:** Tabela `eventos` sem auto-increment  
**SOLU√á√ÉO:** Execute `/VERIFICAR_TABELA_EVENTOS.sql`  
**RESULTADO:** Eventos ser√£o criados com ID autom√°tico  

---

**Execute o script SQL e tente criar um evento novamente! üöÄ**
